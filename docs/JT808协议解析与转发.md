# JT808协议解析与转发设计

## 1. 协议头结构

JT808标准协议头格式如下：

| 字节 | 含义         | 说明                 |
|------|--------------|----------------------|
| 0-1  | 消息ID       | 2字节，big-endian    |
| 2-3  | 消息体属性   | 2字节，big-endian    |
| 4-9  | 终端手机号   | 6字节BCD码           |
| 10-11| 消息流水号   | 2字节，big-endian    |
| 12-13| 分包总数     | 2字节，分包时存在    |
| 14-15| 分包序号     | 2字节，分包时存在    |

- 消息体属性第14位（0x2000）为1时，表示有分包字段。
- 终端手机号为BCD编码，需转换为字符串。

## 2. 解析思路
- 先判断数据长度，按协议格式解析各字段。
- 支持分包字段的可选解析。
- 解析结果用数据类（JT808Header）封装。

## 3. 代码实现
- `jt808proxy/core/jt808_parser.py` 实现协议头解析器。
- 提供 `parse_header(data: bytes)` 静态方法，返回解析结果。

## 4. 转发机制实现
- ✅ 支持一对一/多对一两种转发模式。
- ✅ 按终端手机号智能匹配目标服务器。
- ✅ 支持终端到目标服务器的映射配置。
- ✅ 自动建立和维护目标服务器连接。
- ✅ 转发失败时自动清理失效连接。

### 转发模式说明
- **一对一模式**：每个终端映射到独立的目标服务器
- **多对一模式**：所有终端转发到统一的默认目标服务器

### 核心组件
- `Forwarder`：转发器主类
- `TargetServer`：目标服务器配置
- `ForwardingConfig`：转发配置管理

## 5. 后续计划
- 集成协议解析到TCP服务主流程。
- 实现基础转发逻辑。
- 持续完善协议解析与异常处理。

如有协议变更或特殊需求，请及时补充本文档。 